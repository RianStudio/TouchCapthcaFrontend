<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Captchca Demo</title>
    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="assets/jquery.cookie.js"></script>
    <script type="text/javascript" src="assets/jquery.base64.js"></script>
    <script src="assets/jquery-ui.js"></script>
    <script type="text/javascript" src="assets/func.js"></script>
    <style type="text/css">
        .box_1{
            position:relative;
            height: 200px;
            width: 260px;
            background-color: antiquewhite;

        }
        .box_2{
            height: 30px;
            width: 260px;
            background-color: antiquewhite;
        }
        .but {
            height: 30px;
            width: 40px;
            position: absolute;
            cursor: pointer;
            border: 1px solid orangered;
        }
        .but-drag{
            background-color: beige;
        }

        .hidden{
            display: none;
        }

        .pic-k{
            width: 240px;
            height: 180px;
            position: absolute;
            left: 10px;
            top: 10px;
            overflow: hidden;
        }


        .div-a{ position:absolute;  z-index: 10}

        .div-b{ position:absolute;   z-index: 20}

        .div-c{ position:relative;   z-index: 30}


        /*美化界面*/



        .container{
            width: 960px;
            margin: 0 auto;
        }
        .content{
            width: 960px;
            margin: 10 auto;
            border-top: 1px solid #ccc;

        }
        .box{
            width:300px;
            margin: 30px auto;
        }
        .header{
            margin: 80px auto 30px auto;
            text-align: center;
            font-size: 28px;
        }
        input{
            width: 200px;
            padding: 6px 9px;
        }
        #submit-but{
            cursor: pointer;
            line-height: 35px;
            width: 110px;
            margin:30px 0 0 90px;
            border: 1px solid #FFFFF0;
            background-color: #31C552;
            border-radius: 4px;
            font-size: 14px;
            color: #FFFFF0;
        }

    </style>
</head>
<body >
<div class="container">
<div class="header">
<h1>captchca</h1>
</div>
<div class="content">
<form action="form.php" method="post">

    <div class="box">
    <label for="email"  >邮箱:</label><input type="email" name="email" id="email" value="test@coderfix.cn"><br/>
</div><div class="box">
    <label for="password">密码:</label><input type="password" name="password" id="password" value="123456"><br/>
</div>

    <div class="box">

    <div class="captchca_box " id="captchca_box">

        <!--<div class="box_1" id="box_1" >-->
            <!--&lt;!&ndash;放置隐藏的文本域&ndash;&gt;-->
            <!--<input type="hidden" name="tc_key" id="tc_key">-->
            <!--<input type="hidden" name="tc_base" id="tc_base">-->
            <!--<input type="hidden" name="tc_postion" id="tc_postion">-->
            <!--<div id="div-a" class="div-a pic-k">图片载入中</div>-->
            <!--<div id="div-b" class="div-b pic-k"> </div>-->
            <!--<div id="div-c" class="div-c pic-k">-->
                <!--<div class="but" id="but-u"><img src="" id="drag_img"></div>-->
            <!--</div>-->

        <!--</div>-->
        <!--<div class="box_2" id="box_2">-->
            <!--<em id="wtext">拖拽图片进行验证</em> <button onclick="init()" type="button">重新载入图片</button>-->
        <!--</div>-->

    </div>

        </div>
    <div class="box">

    <button id="submit-but" type="submit" value="submit" >Commit</button></div>

</form>
</div>
</div>

<script>

    createHtml();
    init();

    function  init(){
        showA();
          showD();
            //图片展示区域为240 180
            //240/6= 40  180/6=30
            //获取当前的key

        //读取配置文件
//        tc_app_key=""; //初始化数据
//        tc_app_secret="";
//        ajax_url="";
        $.ajaxSettings.async = false;
        $.getJSON("assets/tconfig.json",function(data){
//            console.log(data.conf.sk);
             tc_app_key=data.conf.sk;
             tc_app_secret=data.conf.ss;
             ajax_url=data.server.getUrl;
        });

        console.log(tc_app_key);

        $.ajaxSettings.async = true;
            var massage;


            //没有加载的时候需要展示的图片
            //js流程,加载完成之后,进行数据的展示
            massage=new Object();
            $.ajax({
                type: "GET",
                url: ajax_url,
//                async:false,
                data: {k:tc_app_key, s:tc_app_secret},
                dataType: "json",
                success: function(data){
                    //对返回结果进行判断
                    if(data.type == 0){
                        showA();
                        hiddenD();
                        //文字改成验证失败
                        $("#div-a").html("请检查APP密钥,通讯失败!");


                    }else{
                        showC();
                        massage=data;
                        console.log(data);
                        initDraggable(massage);
                    }


                },
                error : function() {
                    console.log("加载失败啦~");
                },
                beforeSend:function(){
                    showA();
                }
            });



            function initDraggable(massage){
                showInput()

                //初始化图片
                var pic=massage.a;
                var bg_pic=massage.r;
                var icon=massage.w;


                //进行按钮的裁剪
                $("#drag_img").attr("src",icon);
                $("#div-c").css('background',"url('"+pic+"')");
                $("#div-b").css('background',"url('"+bg_pic+"')");


                //初始化碎片所在位置

                $('#but-u').css('top',0);
                $('#but-u').css('left',0);

                //碎片随机移动

                //ajax获取对应的坐标

                var fix=5;


                $("#but-u").draggable(
                        {
                            containment: "parent",
                            create: function (event, ui) {


                            }, drag: function (event, ui) {
                            // Keep the left edge of the element
                            // at least 100 pixels from the container
                            ui.position.left = Math.min(250, ui.position.left);

//                        $("#drag").addClass('but-drag');
                            showC();
                            //console.log('left:'+ui.position.left+'  top:'+ui.position.top);

                        }, stop: function (event, ui) {

                            //停止之后,进行检测
                            if( Math.abs( ui.position.left - massage.x )  < fix && Math.abs( ui.position.top - massage.y )  < fix  ){
                                setHiddenValue(ui.position.left,ui.position.top,tc_app_key,tc_app_secret);
                                showCom();
                                showB();
                                //把当前的坐标传给隐藏文本域


                            }
                        }

                        }
                );
            }



//        });
    }

    function createHtml(){
        var box_1=$("<div></div>").attr({"id":"box_1","class":"box_1"});
        var box_2=$("<div></div>").attr({"id":"box_2","class":"box_2"});

        var input_1 = $("<input />").attr({"type":"hidden","name":"tc_key","id":"tc_key"});
        var input_2 = $("<input />").attr({"type":"hidden","name":"tc_base","id":"tc_base"});
        var input_3 = $("<input />").attr({"type":"hidden","name":"tc_postion","id":"tc_postion"});

        var div_a=$("<div></div>").attr({"id":"div-a","class":" div-a pic-k "});
        var div_b=$("<div></div>").attr({"id":"div-b","class":" div-b pic-k "});
        var div_c=$("<div></div>").attr({"id":"div-c","class":" div-c pic-k "});

        var img_drag=$("<div></div>").attr({"id":"but-u","class":" but "});
        var img_img=$("<img />").attr({"src":"xxx","id":"drag_img"});

        var em = $("<em><em/>").attr({"id": "wtext"}).html("拖拽图片进行验证");
        var but=$("<button>").attr("type","button").html("重新载入图片").click(function(){init()});

        box_2.append(em,but);
        img_drag.append(img_img);
        div_c.append(img_drag);
        box_1.append(input_1,input_2,input_3,div_a,div_b,div_c);

        $("#captchca_box").append(box_1,box_2);
    }

    function setHiddenValue(x,y,key,secret){
        //获取对应的key
        //简单的加密
        $.base64.utf8encode = true;
        var postion_str= $.base64.btoa($.base64.btoa(x.toString()) + $.base64.btoa(y.toString()));
        var s= $.base64.btoa(secret);
        var tc_key= $.base64.btoa(key);
        $("#tc_base").val(s);
        $("#tc_key").val(tc_key);
        $("#tc_postion").val(postion_str);
    }



    function showInput(){
        $("#wtext").html("等待验证~");
    }

    function showCom(){
        $("#wtext").html("验证完成~");

    }

    function showD(){
        $("#box_2").removeClass('hidden');
    }

    function hiddenD(){
        $("#box_2").addClass('hidden');
    }

    function showA(){
//        $( "#div-a" ).addClass('hidden');
        $( "#div-b" ).addClass('hidden');
        $( "#div-c" ).addClass('hidden');
        $( "#div-a" ).removeClass('hidden');
//        $( "#div-b" ).removeClass('hidden');
//        $( "#div-c" ).removeClass('hidden');
    }
    function showB(){
        $( "#div-a" ).addClass('hidden');
//        $( "#div-b" ).addClass('hidden');
        $( "#div-c" ).addClass('hidden');
//        $( "#div-a" ).removeClass('hidden');
        $( "#div-b" ).removeClass('hidden');
//        $( "#div-c" ).removeClass('hidden');
    }
    function showC(){
        $( "#div-a" ).addClass('hidden');
        $( "#div-b" ).addClass('hidden');
//        $( "#div-c" ).addClass('hidden');
//        $( "#div-a" ).removeClass('hidden');
//        $( "#div-b" ).removeClass('hidden');
        $( "#div-c" ).removeClass('hidden');
    }
    loading()
</script>

</body>
</html>