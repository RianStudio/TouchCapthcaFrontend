<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>demo</title>
    <script type="text/javascript" src="assets/jquery-2.1.4.min.js"></script>
    <script src="assets/jquery-ui.js"></script>
    <script type="text/javascript" src="assets/func.js"></script>
    <style type="text/css">
        .box_1{
            position:relative;
            height: 200px;
            width: 260px;
            background-color: antiquewhite;

        }
        .box_2{
            height: 30px;
            width: 260px;
            background-color: antiquewhite;
        }

        .but{
            height: 30px;
            width: 40px;
            position: absolute;
            cursor:pointer;
            border:1px solid #000
        }

        .but-drag{
            background-color: beige;
        }


        .hidden{
            display: none;

        }

        .pic-k{
            width: 240px;
            height: 180px;
            position: absolute;
            left: 10px;
            top: 10px;
            overflow: hidden;
        }






        .div-a{ position:absolute;  z-index: 10}
        /* css注释说明： 背景为红色 */
        .div-b{ position:absolute;   z-index: 20}
        /* 背景为黄色 */
        .div-c{ position:relative;   z-index: 30}
        /* DIV背景颜色为蓝色 */



    </style>
</head>
<body>

<h1>captchca demo</h1>

<form action="#" method="post">


    <label for="email"  >email</label><input type="email" name="email" id="email"><br/>

    <label for="password"  >password</label><input type="password" name="password" id="password"><br/>



    <div class="captchca_box ">

        <div class="box_1" >
            <!--放置一个图片-->
            <div id="div-a" class="div-a pic-k">图片载入中</div>
            <div id="div-b" class="div-b pic-k"> </div>
            <div id="div-c" class="div-c pic-k">
                <div class="but" id="but-u"><img src="" id="drag_img"></div>
                <!--<img src="" id="" class="but" >-->
            </div>


        </div>
        <div class="box_2">
            <em id="wtext">拖拽图片进行验证</em> <button onclick="init()" type="button">重新载入图片</button>
        </div>

    </div><br/>

    <button type="submit" value="submit" >Commit</button>

</form>



<script>


    init();

    function  init(){
//        $(function () {
            showA();
            //图片展示区域为240 180
            //240/6= 40  180/6=30

            //获取当前的key v
            var massage;
            var ajax_url="http://tback.localhost:8080/picture?k=xxxv&v=xxx";
            //请求对应的结果
//            $.get(ajax_url, function(result){
//
//                console.log(result);
//
//                massage=result;
//                alert(massage.a);
//            });

            //没有加载的时候需要展示的图片
            //js流程,加载完成之后,进行数据的展示
            massage=new Object();
            massage.a="";
            massage.r="";
            massage.w="";
            massage.x=0;
            massage.u=0;
            $.ajax({
                type: "GET",
                url: ajax_url,
//                async:false,
                data: {k:"xxx", v:"jjj"},
                dataType: "json",
                success: function(data){
                    showC();
                    massage=data;

                    initDraggable(massage);

                },
                error : function() {
                    console.log("加载失败啦~");
                },
                beforeSend:function(){
                    showA();
                }
            });



            function initDraggable(massage){
                showInput()

                //初始化图片
                var pic=massage.a;
                var bg_pic=massage.r;
                var icon=massage.w;


                //进行按钮的裁剪
                $("#drag_img").attr("src",icon);
                $("#div-c").css('background',"url('"+pic+"')");
                $("#div-b").css('background',"url('"+bg_pic+"')");


                //初始化碎片所在位置

                $('#but-u').css('top',0);
                $('#but-u').css('left',0);

                //碎片随机移动

                //ajax获取对应的坐标



                $("#but-u").draggable(
                        {
                            containment: "parent",
                            create: function (event, ui) {


                            }, drag: function (event, ui) {
                            // Keep the left edge of the element
                            // at least 100 pixels from the container
                            ui.position.left = Math.min(250, ui.position.left);

//                        $("#drag").addClass('but-drag');
                            showC();
                            //console.log('left:'+ui.position.left+'  top:'+ui.position.top);

                        }, stop: function (event, ui) {

                            //停止之后,进行检测
                            if( Math.abs( ui.position.left - massage.x )  < 10 && Math.abs( ui.position.top - massage.y )  < 10  ){
                                showCom();
                                showB();
                            }
                        }

                        }
                );
            }






//        });
    }


    function showInput(){
        $("#wtext").html("等待验证~");
    }

    function showCom(){
        $("#wtext").html("验证完成~");

    }

    function showA(){
//        $( "#div-a" ).addClass('hidden');
        $( "#div-b" ).addClass('hidden');
        $( "#div-c" ).addClass('hidden');
        $( "#div-a" ).removeClass('hidden');
//        $( "#div-b" ).removeClass('hidden');
//        $( "#div-c" ).removeClass('hidden');
    }
    function showB(){
        $( "#div-a" ).addClass('hidden');
//        $( "#div-b" ).addClass('hidden');
        $( "#div-c" ).addClass('hidden');
//        $( "#div-a" ).removeClass('hidden');
        $( "#div-b" ).removeClass('hidden');
//        $( "#div-c" ).removeClass('hidden');
    }
    function showC(){
        $( "#div-a" ).addClass('hidden');
        $( "#div-b" ).addClass('hidden');
//        $( "#div-c" ).addClass('hidden');
//        $( "#div-a" ).removeClass('hidden');
//        $( "#div-b" ).removeClass('hidden');
        $( "#div-c" ).removeClass('hidden');
    }
    loading()
</script>
</body>
</html>